<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ç¨³å®šå¸é›·è¾¾ Â· Stablecoin Radar</title>
<meta name="description" content="Top 20 ç¨³å®šå¸ Â· æœ¬åœ°ç¼“å­˜ Â· é£é™©æ ‡ç­¾ Â· å»é”šè®¡ç®— Â· ç»„åˆæ•å£">
<meta name="theme-color" content="#7aefff">
<style>
/* ===== THEMEï¼šä¸»è‰²é è¿‘ #7aefffï¼Œæ¨¡å—è½»æ¸å˜ + æè¾¹ ===== */
:root{
  --bg:#0b1220; --bg2:#0b1426; --card:#0f172a; --muted:#9fb3d9; --text:#e8f0ff;
  --brand:#7aefff; --brand-2:#c8fbff; /* æ›´é è¿‘ 7aefff */
  --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  --border:#1a2a4a; --chip:#0f1e36;
  --glow: rgba(122,239,255,.18);
  --shadow:0 10px 30px rgba(0,20,60,.35);
  --radius:20px; --radius-sm:12px; --radius-lg:24px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--text);
  background:
    radial-gradient(1000px 800px at 10% -10%,rgba(122,239,255,.10),transparent 60%),
    linear-gradient(180deg,#0b1220 0%,#0b1220 60%,#08101e 100%);
  font:15px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","PingFang SC","Hiragino Sans GB","Noto Sans SC","Microsoft YaHei",Arial;
  letter-spacing:.1px;
}
a{color:var(--brand);text-decoration:none}
.container{max-width:1160px;margin:0 auto;padding:16px 18px}

/* ===== TOPBARï¼ˆåŠç»ç’ƒï¼‰ ===== */
.topbar{position:sticky;top:0;z-index:40;
  backdrop-filter:blur(10px);
  background:linear-gradient(180deg,rgba(8,16,30,.85),rgba(8,16,30,.55));
  border-bottom:1px solid var(--border)}
.toprow{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 18px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:38px;height:38px;border-radius:12px;
  background:conic-gradient(from 210deg at 50% 50%,var(--brand),var(--brand-2),#eaffff,var(--brand));
  display:grid;place-items:center;box-shadow:0 0 0 1px var(--glow), var(--shadow);border:1px solid #0e2a46}
.logo b{font-weight:900;color:#001b2a}
.ttl{display:flex;flex-direction:column}
.ttl h1{margin:0;font-size:18px;font-weight:800;letter-spacing:.3px}
.ttl small{margin-top:2px;color:var(--muted);font-size:12px}
.right{display:flex;align-items:center;gap:10px}
.select, .btn{
  appearance:none;background:#0a1a30;border:1px solid var(--border);color:var(--text);
  padding:8px 12px;border-radius:12px;cursor:pointer
}
.btn:hover{background:#0e243f}
.btn.primary{
  background:linear-gradient(135deg,var(--brand),var(--brand-2));border:none;color:#052336;font-weight:800;
  box-shadow:0 0 0 1px var(--glow), 0 6px 20px rgba(122,239,255,.18)}
.badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;background:var(--chip);
  border:1px solid var(--border);border-radius:999px;padding:4px 8px;color:#cfe2ff}

/* ===== GRID ===== */
.grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px;margin-top:14px}
@media(max-width:1000px){.grid{grid-template-columns:1fr}}

/* ===== CARDï¼ˆè½»æ¸å˜ + å†…æè¾¹å‘å…‰ï¼‰ ===== */
.card{
  background:linear-gradient(180deg,#0f172a 0%,#0c1628 100%);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:0 0 0 1px var(--glow) inset, var(--shadow);
  overflow:hidden
}
.card .hd{display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:12px 14px;border-bottom:1px solid var(--border)}
.card .bd{padding:12px 14px}

/* ===== KPIs ===== */
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
@media(max-width:1000px){.kpis{grid-template-columns:repeat(2,1fr)}}
.kpi{
  background:linear-gradient(180deg,rgba(13,37,58,.9),rgba(12,28,48,.9));
  border:1px solid var(--border); border-radius:var(--radius-sm);
  box-shadow:0 0 0 1px var(--glow) inset;
  padding:12px}
.kpi h4{margin:0 0 6px 0;font-size:12px;color:var(--muted);font-weight:600}
.kpi b{font-size:20px;font-weight:800}

/* ===== INPUTS ===== */
.input{display:flex;gap:8px;align-items:center}
.input input, .input select{
  flex:1;min-width:0;background:#0a1a30;border:1px solid var(--border);color:var(--text);
  padding:10px 12px;border-radius:12px}
.input input::placeholder{color:#7c97c9}

/* ===== TABLEï¼ˆè¡¨å¤´åŠé€æ˜æ¯›ç»ç’ƒï¼‰ ===== */
.table-wrap{overflow:auto}
.table{width:100%;border-collapse:separate;border-spacing:0}
.table thead th{
  position:sticky;top:0;z-index:5;
  background:rgba(15,23,42,.55); /* åŠé€æ˜ */
  -webkit-backdrop-filter:blur(10px);
  backdrop-filter:blur(10px);
  border-bottom:1px solid var(--border);
  font-size:12px;color:var(--muted);text-align:left;padding:10px 10px;font-weight:700
}
.table thead th.sortable{cursor:pointer}
.table thead th .arrow{opacity:.35;margin-left:6px}
.table tbody tr{transition:background .2s ease}
.table tbody tr:hover{background:rgba(12,27,49,.8)}
.cell{padding:12px 10px;border-bottom:1px dashed #152545;vertical-align:middle}
.rank{width:36px;color:#c3edff;opacity:.95}
.token{display:flex;align-items:center;gap:10px}
.tlogo{width:28px;height:28px;border-radius:10px;background:#0b1d35;border:1px solid #153453;
  display:grid;place-items:center;font-weight:900;color:#bfe6ff}
.token .meta{display:flex;flex-direction:column}
.token .meta .name{font-weight:800}
.token .meta .sym{font-size:12px;color:var(--muted)}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;border:1px solid var(--border);
  border-radius:999px;padding:4px 8px;background:var(--chip); box-shadow:0 0 0 1px var(--glow) inset}
.chip.ok{color:var(--ok)} .chip.warn{color:var(--warn)} .chip.bad{color:var(--bad)}
.btn-ghost{appearance:none;background:#0a1a30;border:1px solid var(--border);color:#cfe2ff;
  padding:8px 10px;border-radius:10px;cursor:pointer}
.btn-ghost:hover{background:#0e223a}

/* ===== TOOLBOX ===== */
.tools{display:grid;grid-template-columns:1fr;gap:12px}
.tool.card{border:none;border-radius:var(--radius-sm);overflow:hidden}
.tool .hd{background:transparent;border-bottom:1px dashed #183052;padding:10px 12px}
.tool .bd{padding:10px 12px}
.help{font-size:12px;color:var(--muted)}
.sep{border:0;border-top:1px dashed #183052;margin:12px 0}

/* ===== FOOTER ===== */
.footer{opacity:.85;text-align:center;font-size:12px;padding:18px;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}
.tag{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--border);
  color:#cfe2ff;border-radius:999px;padding:4px 8px;font-size:12px; box-shadow:0 0 0 1px var(--glow) inset}

/* micro interactions */
.fade{animation:fade .25s ease}
@keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
</style>
</head>
<body>
  <!-- ===== TOP BAR ===== -->
  <div class="topbar">
    <div class="toprow container">
      <div class="brand">
        <div class="logo"><b>â‚®$</b></div>
        <div class="ttl">
          <h1 data-i18n="title">ç¨³å®šå¸é›·è¾¾</h1>
          <small data-i18n="subtitle">Top 20 ç¨³å®šå¸ Â· æœ¬åœ°ç¼“å­˜ Â· é£é™©æ ‡ç­¾</small>
        </div>
      </div>
      <div class="right">
        <select id="lang" class="select" aria-label="Language">
          <option value="zh">ä¸­æ–‡</option>
          <option value="en">English</option>
        </select>
        <a class="btn primary" href="https://x.com/menglayer" target="_blank" rel="noopener" data-i18n="follow">å…³æ³¨ @menglayer</a>
      </div>
    </div>
  </div>

  <div class="container fade">
    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi"><h4 data-i18n="k1">æ€»ç¨³å®šå¸å¸‚å€¼ (å¿«ç…§/ç¼“å­˜)</h4><b id="kTotal">$â€”</b><div class="small" id="kAsOf"></div></div>
      <div class="kpi"><h4 data-i18n="k2">è¿½è¸ªå¸ç§</h4><b id="kCount">â€”</b><div class="small" data-i18n="k2d">åŸºäº DefiLlama Top 20ï¼ˆé¦–æ¬¡åŠ è½½ï¼‰</div></div>
      <div class="kpi"><h4 data-i18n="k3">å»é”šé¢„è­¦</h4><b id="kDepeg">â€”</b><div class="small" data-i18n="k3d">ä»·æ ¼åç¦»é˜ˆå€¼ï¼šÂ±0.3%</div></div>
      <div class="kpi">
        <h4 data-i18n="k4">ç¼“å­˜çŠ¶æ€</h4>
        <b id="kCache">â€”</b>
        <div class="small">
          <button id="refresh" class="btn-ghost" data-i18n="refresh">æ‰‹åŠ¨åˆ·æ–°</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- ===== LEFT: TABLE ===== -->
      <div class="card">
        <div class="hd">
          <div class="input" style="flex:1">
            <input id="search" placeholder="æœç´¢åç§°/ç¬¦å·â€¦" aria-label="Search">
            <select id="filter" aria-label="Filter">
              <option value="" data-i18n="all">å…¨éƒ¨ç±»å‹</option>
              <option value="fiat" data-i18n="fiat">æ³•å¸å‚¨å¤‡</option>
              <option value="crypto" data-i18n="crypto">åŠ å¯†æŠµæŠ¼</option>
              <option value="algo" data-i18n="algo">ç®—æ³•/åˆæˆ</option>
              <option value="hybrid" data-i18n="hybrid">æ··åˆ/å…¶ä»–</option>
            </select>
          </div>
      
        </div>
        <div class="bd table-wrap">
          <table class="table" id="tbl">
            <thead>
              <tr>
                <th class="sortable" data-sort="rank"># <span class="arrow">â†•</span></th>
                <th data-i18n="th1">ç¨³å®šå¸</th>
                <th class="sortable" data-sort="price" data-i18n="th2">ä»·æ ¼ <span class="arrow">â†•</span></th>
                <th class="sortable" data-sort="mcap" data-i18n="th3">æµé€šå¸‚å€¼ <span class="arrow">â†•</span></th>
                <th data-i18n="th4">æœºåˆ¶</th>
                <th data-i18n="th5">é»‘åå•/å†»ç»“</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>

      <!-- ===== RIGHT: TOOLBOX ===== -->
      <aside class="card">
        <div class="hd">
          <b data-i18n="tools">å·¥å…·ç®±</b>
          <span class="tag">ğŸ“¦ <span data-i18n="cache">æœ¬åœ°ç¼“å­˜ä¼˜å…ˆ</span></span>
        </div>
        <div class="bd">
          <section class="tool card">
            <div class="hd"><b>ğŸª™ <span data-i18n="calc1">å»é”šæŸç›Šè®¡ç®—å™¨</span></b></div>
            <div class="bd">
              <div class="input">
                <input id="dpAmount" type="number" step="0.01" placeholder="æŒæœ‰æ•°é‡" aria-label="Holding amount">
                <input id="dpPrice" type="number" step="0.0001" placeholder="å½“å‰ä»·æ ¼(USD)" aria-label="Current price">
              </div>
              <div class="input" style="margin-top:8px">
                <input id="dpRef" type="number" step="0.0001" value="1" aria-label="Reference price">
                <button class="btn-ghost" id="dpRun" data-i18n="run">è®¡ç®—</button>
              </div>
              <div id="dpOut" class="small" style="margin-top:6px"></div>
            </div>
          </section>

          <section class="tool card">
            <div class="hd"><b>ğŸ“Š <span data-i18n="calc2">æŒä»“æ•å£åˆ†æ</span></b></div>
            <div class="bd">
              <div class="help" data-i18n="calc2d">è¾“å…¥â€œç¬¦å·:æ•°é‡â€ï¼Œä»¥é€—å·åˆ†éš”ï¼ˆä¾‹ï¼šUSDT:10000, DAI:5000, GHO:1200ï¼‰</div>
              <div class="input" style="margin:6px 0">
                <input id="pf" placeholder="USDT:10000, USDC:8000" aria-label="Portfolio input">
              </div>
              <button class="btn-ghost" id="pfRun" data-i18n="run">è®¡ç®—</button>
              <div id="pfOut" class="small" style="margin-top:6px"></div>
            </div>
          </section>

          <hr class="sep">
          <div class="help">
            ğŸ”— <span data-i18n="transparency">é€æ˜åº¦/å‚¨å¤‡æŠ«éœ²è§å„å®˜ç½‘æˆ–å®¡è®¡é¡µ</span>
          </div>
        </div>
      </aside>
    </div>

    <footer class="footer">
      <div>Data source: DefiLlama Stablecoins APIï¼ˆé¦–æ¬¡ç¼“å­˜åæœ¬åœ°è¯»å–ï¼‰ã€‚</div>
      <div class="small">Â© 2025 Stablecoin Radar Â· <span class="chip" style="border-color:#143a48;background:#0a1f2a;color:#d7fbff" data-i18n="disc">å…è´£å£°æ˜ï¼šä»…ä¾›ç ”ç©¶å‚è€ƒï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚</span></div>
    </footer>
  </div>

<script>
/* ===================== I18N ===================== */
const I18N = {
  zh:{title:"ç¨³å®šå¸é›·è¾¾",subtitle:"Top 20 ç¨³å®šå¸ Â· æœ¬åœ°ç¼“å­˜ Â· é£é™©æ ‡ç­¾",
    follow:"å…³æ³¨ @menglayer",k1:"æ€»ç¨³å®šå¸å¸‚å€¼ (å¿«ç…§/ç¼“å­˜)",k2:"è¿½è¸ªå¸ç§",k2d:"åŸºäº DefiLlama Top 20ï¼ˆé¦–æ¬¡åŠ è½½ï¼‰",
    k3:"å»é”šé¢„è­¦",k3d:"ä»·æ ¼åç¦»é˜ˆå€¼ï¼šÂ±0.3%",k4:"ç¼“å­˜çŠ¶æ€",refresh:"æ‰‹åŠ¨åˆ·æ–°",
    all:"å…¨éƒ¨ç±»å‹",fiat:"æ³•å¸å‚¨å¤‡",crypto:"åŠ å¯†æŠµæŠ¼",algo:"ç®—æ³•/åˆæˆ",hybrid:"æ··åˆ/å…¶ä»–",
    th1:"ç¨³å®šå¸",th2:"ä»·æ ¼",th3:"æµé€šå¸‚å€¼",th4:"æœºåˆ¶",th5:"é»‘åå•/å†»ç»“",
    tools:"å·¥å…·ç®±",cache:"æœ¬åœ°ç¼“å­˜ä¼˜å…ˆ",calc1:"å»é”šæŸç›Šè®¡ç®—å™¨",run:"è®¡ç®—",calc2:"æŒä»“æ•å£åˆ†æ",
    calc2d:"è¾“å…¥â€œç¬¦å·:æ•°é‡â€ï¼Œä»¥é€—å·åˆ†éš”ï¼ˆä¾‹ï¼šUSDT:10000, DAI:5000, GHO:1200ï¼‰",
    transparency:"é€æ˜åº¦/å‚¨å¤‡æŠ«éœ²è§å„å®˜ç½‘æˆ–å®¡è®¡é¡µ",
    disc:"å…è´£å£°æ˜ï¼šä»…ä¾›ç ”ç©¶å‚è€ƒï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚",
    price:"ä»·æ ¼",mcap:"å¸‚å€¼",mech:"æœºåˆ¶",risk:"é£é™©/å†»ç»“",peg:"é”šå®šç±»å‹ï¼š",freeze:"å†»ç»“ï¼š",blacklist:"é»‘åå•ï¼š",yes:"æ˜¯",no:"å¦",
    desc:"ç®€ä»‹",snapshot:"å¿«ç…§æ—¶é—´",notAvail:"â€”"},
  en:{title:"Stablecoin Radar",subtitle:"Top 20 Â· Local Cache Â· Risk Labels",
    follow:"Follow @menglayer",k1:"Total Stablecoin MktCap (snapshot/cache)",k2:"Tracked Coins",k2d:"DefiLlama Top 20 (first load)",
    k3:"Depeg Alerts",k3d:"Deviation threshold: Â±0.3%",k4:"Cache Status",refresh:"Manual Refresh",
    all:"All Types",fiat:"Fiat-Backed",crypto:"Crypto-Collateralized",algo:"Algorithmic/Synthetic",hybrid:"Hybrid/Other",
    th1:"Stablecoin",th2:"Price",th3:"Mkt Cap",th4:"Mechanism",th5:"Blacklist/Freeze",
    tools:"Toolbox",cache:"Local cache first",calc1:"Depeg P/L Calculator",run:"Run",calc2:"Portfolio Exposure",
    calc2d:'Enter "SYMBOL:AMOUNT" comma-separated (e.g., USDT:10000, DAI:5000, GHO:1200)',
    transparency:"See transparency/reserves on each official site",
    disc:"Disclaimer: For research only. Not investment advice.",
    price:"Price",mcap:"Mkt Cap",mech:"Mechanism",risk:"Risk/Freeze",peg:"Peg Type: ",freeze:"Freeze:",blacklist:"Blacklist:",yes:"Yes",no:"No",
    desc:"Overview",snapshot:"Snapshot at",notAvail:"â€”"}
};
let LANG = localStorage.getItem('sc_lang')||'zh';

/* ===================== DATA ===================== */
const API_URL = 'https://stablecoins.llama.fi/stablecoins?includePrices=true';
const SEEDED_AT = '2025-08-19T00:00:00Z';
const SEED = [
  { name:'Tether', symbol:'USDT', price:1.0, mcap:null, pegMechanism:'fiat-backed' },
  { name:'USD Coin', symbol:'USDC', price:1.0, mcap:null, pegMechanism:'fiat-backed' },
  { name:'Ethena USDe', symbol:'USDe', price:1.0, mcap:null, pegMechanism:'synthetic delta-hedged' },
  { name:'Sky Dollar', symbol:'USDS', price:1.0, mcap:null, pegMechanism:'crypto-backed CDP' },
  { name:'Dai', symbol:'DAI', price:1.0, mcap:null, pegMechanism:'crypto-backed CDP' },
  { name:'First Digital USD', symbol:'FDUSD', price:1.0, mcap:null, pegMechanism:'fiat-backed' },
  { name:'PayPal USD', symbol:'PYUSD', price:1.0, mcap:null, pegMechanism:'fiat-backed' },
  { name:'Global Dollar', symbol:'USDG', price:1.0, mcap:null, pegMechanism:'fiat-backed (Paxos EU/SG)' },
  { name:'Frax USD', symbol:'frxUSD', price:1.0, mcap:null, pegMechanism:'hybrid (custodial+onchain)' },
  { name:'Frax (legacy)', symbol:'FRAX', price:1.0, mcap:null, pegMechanism:'hybrid' },
  { name:'crvUSD', symbol:'crvUSD', price:1.0, mcap:null, pegMechanism:'crypto-backed CDP' },
  { name:'Liquity USD', symbol:'LUSD', price:1.0, mcap:null, pegMechanism:'crypto-backed CDP (ETH only)' },
  { name:'Aave GHO', symbol:'GHO', price:1.0, mcap:null, pegMechanism:'crypto-backed (Aave)' },
  { name:'USDD', symbol:'USDD', price:1.0, mcap:null, pegMechanism:'overcollateralized (TRON DAO)' },
  { name:'TrueUSD', symbol:'TUSD', price:1.0, mcap:null, pegMechanism:'fiat-backed' },
  { name:'Pax Dollar', symbol:'USDP', price:1.0, mcap:null, pegMechanism:'fiat-backed' },
  { name:'sUSD', symbol:'sUSD', price:1.0, mcap:null, pegMechanism:'synthetic (Synthetix)' },
  { name:'eUSD (Lybra)', symbol:'eUSD', price:1.0, mcap:null, pegMechanism:'crypto-backed LSD' },
  { name:'EURC', symbol:'EURC', price:1.0, mcap:null, pegMechanism:'fiat-backed (EUR)' },
  { name:'agEUR', symbol:'agEUR', price:1.0, mcap:null, pegMechanism:'crypto-backed (EUR)' },
];

/* ===================== STATE & HELPERS ===================== */
let DATA = []; let SNAPSHOT_AT = null; let DEVIATION = 0.003; // 0.3%
const $ = s => document.querySelector(s); const $$ = s => Array.from(document.querySelectorAll(s));
function fmt(n,d=2){ if(n==null||isNaN(+n)) return I18N[LANG].notAvail;
  const a=Math.abs(+n); if(a>=1e12) return (n/1e12).toFixed(d)+'T';
  if(a>=1e9) return (n/1e9).toFixed(d)+'B'; if(a>=1e6) return (n/1e6).toFixed(d)+'M';
  if(a>=1e3) return (n/1e3).toFixed(d)+'K'; return (+n).toFixed(d); }
function nowISO(){return new Date().toISOString();}
function setLang(l){ LANG=l; localStorage.setItem('sc_lang',l);
  $$('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n'); el.textContent=I18N[LANG][k]||k;}); }

/* ===================== CLASSIFIERS ===================== */
function classifyMechanism(x){
  const m=(x.pegMechanism||'').toLowerCase(); const s=(x.symbol||'').toUpperCase();
  if(/fiat|cash|treasur|reserve/.test(m) || ['USDT','USDC','PYUSD','FDUSD','USDP','USDG','TUSD'].includes(s)) return 'fiat';
  if(/crypto|cdp|overcoll/.test(m) || ['DAI','USDS','LUSD','GHO','crvUSD','USDD'].includes(s)) return 'crypto';
  if(/algo|rebase|synthe/.test(m)) return 'algo';
  if(['FRAX','frxUSD'].includes(s)) return 'hybrid';
  return 'hybrid';
}
function riskFlags(sym){
  const s=(sym||'').toUpperCase();
  const central=['USDT','USDC','PYUSD','FDUSD','USDP','USDG','TUSD'];
  if(central.includes(s)) return {blacklist:true,freeze:true,note:'Issuer-controlled blacklist/freeze'};
  if(['DAI','USDS','GHO'].includes(s)) return {blacklist:false,freeze:false,note:'Governance params; no per-address blacklist'};
  if(['LUSD','crvUSD'].includes(s)) return {blacklist:false,freeze:false,note:'No issuer blacklist (CDP)'};
  if(s==='FRAX' || s==='FRXUSD') return {blacklist:true,freeze:true,note:'Custodial components in v3/frxUSD'};
  if(s==='USDD') return {blacklist:false,freeze:false,note:'Protocol claims freeze-free'};
  return {blacklist:false,freeze:false,note:''};
}

/* ===================== CACHE ===================== */
async function fetchOnceAndCache(){
  const res = await fetch(API_URL,{mode:'cors'}); if(!res.ok) throw new Error('HTTP '+res.status);
  const json = await res.json();
  let arr=(json.peggedAssets||[]).filter(x=> (x.pegType||'').toLowerCase()==='peggedusd');
  arr.sort((a,b)=> (b.circulating?.peggedUSD||0) - (a.circulating?.peggedUSD||0));
  arr=arr.slice(0,20);
  const takeNumber=(obj)=>{
    if(obj==null) return null;
    if(typeof obj==='number') return obj;
    if(typeof obj==='object'){ for(const k of Object.keys(obj)){ const v=takeNumber(obj[k]); if(typeof v==='number') return v; } }
    return null;
  };
  arr=arr.map(x=>({
    id:x.id, name:x.name, symbol:x.symbol, pegMechanism:x.pegMechanism, pegType:x.pegType,
    price: takeNumber(x.price?.USD ?? x.price) ?? null,
    mcapUSD: x.circulating?.peggedUSD ?? null,
    circulating:x.circulating, description:x.description
  }));
  const payload={snapshotAt:nowISO(),data:arr};
  localStorage.setItem('stablecoinRadarCacheV1',JSON.stringify(payload));
  return payload;
}
function loadCache(){
  const raw=localStorage.getItem('stablecoinRadarCacheV1'); if(!raw) return null;
  try{ return JSON.parse(raw);}catch{ return null;}
}

/* ===================== RENDER ===================== */
let SORT = {key:'rank', dir:'asc'}; // rank | price | mcap
function render(){
  const rows=$('#rows'); rows.innerHTML='';
  const q=($('#search').value||'').trim().toLowerCase();
  const f=$('#filter').value;

  let list=DATA.slice();
  if(q) list=list.filter(x=> (x.name||'').toLowerCase().includes(q) || (x.symbol||'').toLowerCase().includes(q));
  if(f) list=list.filter(x=> classifyMechanism(x)===f);

  // sorting
  list=list.map((x,i)=>({...x,_rank:i+1}));
  const val=(x,k)=> k==='price' ? ((x.price?.USD ?? x.price ?? null) ?? -Infinity) :
                          k==='mcap' ? (x.mcapUSD ?? x.circulating?.peggedUSD ?? -Infinity) :
                          x._rank;
  list.sort((a,b)=> (SORT.dir==='asc'?1:-1) * (val(a,SORT.key)-val(b,SORT.key)));

  list.forEach((x,idx)=>{
    const mech=classifyMechanism(x); const risk=riskFlags(x.symbol);
    const price=(x.price?.USD ?? x.price ?? null);
    const mcap=x.mcapUSD ?? (x.circulating?.peggedUSD ?? null);
    const dev=(price && Math.abs(price-1)>=DEVIATION);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="cell rank">${idx+1}</td>
      <td class="cell">
        <div class="token">
          <div class="tlogo">${(x.symbol||'?').slice(0,2)}</div>
          <div class="meta">
            <div class="name">${x.name||'â€”'}</div>
            <div class="sym">${x.symbol||''}</div>
          </div>
        </div>
      </td>
      <td class="cell">
        ${price==null?I18N[LANG].notAvail:`$${fmt(price,4)}`}
        ${price&&dev?`<span class="chip bad" style="margin-left:6px">âš  Depeg</span>`:''}
      </td>
      <td class="cell">${mcap==null?I18N[LANG].notAvail:`$${fmt(mcap,2)}`}</td>
      <td class="cell">
        <span class="chip">${{fiat:'ğŸ’µ Fiat',crypto:'ğŸ›¡ï¸ Crypto',algo:'ğŸ§® Algo',hybrid:'ğŸ§© Hybrid'}[mech]}</span>
      </td>
      <td class="cell">
        <div class="chips">
          ${risk.blacklist?`<span class="chip bad">${LANG==='zh'?'é»‘åå•':'Blacklist'}</span>`:`<span class="chip ok">â€”</span>`}
          ${risk.freeze?`<span class="chip warn">${LANG==='zh'?'å†»ç»“':'Freeze'}</span>`:''}
        </div>
      </td>
    `;
    rows.appendChild(tr);
  });

  const total=DATA.reduce((s,x)=> s + (+x.circulating?.peggedUSD || +x.mcapUSD || 0),0);
  $('#kTotal').textContent='$'+fmt(total,2);
  $('#kAsOf').textContent=SNAPSHOT_AT? `${I18N[LANG].snapshot} ${new Date(SNAPSHOT_AT).toLocaleString()}` : '';
  $('#kCount').textContent=DATA.length;
  const depegs=DATA.filter(x=>{const p=(x.price?.USD ?? x.price ?? null); return p && Math.abs(p-1)>=DEVIATION;}).length;
  $('#kDepeg').textContent=(depegs>0? `${depegs} âš ` : '0 âœ…');
}

/* ===================== EVENTS ===================== */
$('#search').oninput=render; $('#filter').onchange=render;
$('#lang').onchange=(e)=>{ setLang(e.target.value); render(); };
let lastRefreshTs=0;
$('#refresh').onclick=async ()=>{
  const now=Date.now(); if(now-lastRefreshTs<800) return; lastRefreshTs=now;
  $('#kCache').textContent = (LANG==='zh' ? 'åˆ·æ–°ä¸­â€¦' : 'Refreshingâ€¦');
  try{ const out=await fetchOnceAndCache(); DATA=out.data; SNAPSHOT_AT=out.snapshotAt;
    $('#kCache').textContent=(LANG==='zh' ? 'å·²åˆ·æ–°' : 'Refreshed')+' âœ“'; render();
  }catch{ $('#kCache').textContent=(LANG==='zh' ? 'åˆ·æ–°å¤±è´¥' : 'Refresh failed'); }
};

/* ===================== TOOLS ===================== */
function pct(v,total){return total? (v/total*100).toFixed(2)+'%':'â€”';}
$('#dpRun').onclick=()=>{
  const amt=parseFloat($('#dpAmount').value||'0'); const p=parseFloat($('#dpPrice').value||'1'); const ref=parseFloat($('#dpRef').value||'1');
  if(!isFinite(amt)||!isFinite(p)||!isFinite(ref)) return $('#dpOut').textContent='â€”';
  const valueNow=amt*p; const valueRef=amt*ref; const pnl=valueNow-valueRef; const pc=(p-ref)/ref*100;
  $('#dpOut').innerHTML = `<b>${pnl>=0?'+':''}${pnl.toFixed(2)} USD</b> (${pc.toFixed(3)}%)`;
};
$('#pfRun').onclick=()=>{
  const input=($('#pf').value||'').trim(); if(!input) return $('#pfOut').textContent='â€”';
  const parts=input.split(',').map(s=>s.trim()).filter(Boolean);
  let total=0, fiat=0, crypto=0, algo=0, hybrid=0, blk=0, frz=0;
  parts.forEach(p=>{
    const [symRaw,amtRaw]=p.split(':'); if(!symRaw||!amtRaw) return;
    const sym=symRaw.trim().toUpperCase(); const amt=parseFloat(amtRaw.trim()); if(!isFinite(amt)) return;
    const row=DATA.find(x=> (x.symbol||'').toUpperCase()===sym);
    const price=(row?.price?.USD ?? row?.price ?? 1); const mech=row?classifyMechanism(row):'fiat';
    const risk=row?riskFlags(sym):{blacklist:false,freeze:false};
    const usd=amt*(price||1); total+=usd;
    if(mech==='fiat') fiat+=usd; else if(mech==='crypto') crypto+=usd; else if(mech==='algo') algo+=usd; else hybrid+=usd;
    if(risk.blacklist) blk+=usd; if(risk.freeze) frz+=usd;
  });
  $('#pfOut').innerHTML = `
    <div>ğŸ’¼ Total: <b>$${fmt(total,2)}</b></div>
    <div>ğŸ¦ Fiat: ${pct(fiat,total)} Â· ğŸ›¡ï¸ Crypto: ${pct(crypto,total)} Â· ğŸ§® Algo: ${pct(algo,total)} Â· ğŸ§© Hybrid: ${pct(hybrid,total)}</div>
    <div>ğŸš« Blacklistable: ${pct(blk,total)} ãƒ» ğŸ¥¶ Freezable: ${pct(frz,total)}</div>
  `;
};

/* ===================== INIT ===================== */
(async function init(){
  $('#lang').value=LANG; setLang(LANG);
  const cache=loadCache();
  if(cache && Array.isArray(cache.data) && cache.data.length){
    DATA=cache.data; SNAPSHOT_AT=cache.snapshotAt;
    $('#kCache').textContent=(LANG==='zh' ? 'ä½¿ç”¨æœ¬åœ°ç¼“å­˜' : 'Local cache');
  }else{
    try{ const out=await fetchOnceAndCache(); DATA=out.data; SNAPSHOT_AT=out.snapshotAt;
      $('#kCache').textContent=(LANG==='zh' ? 'å·²ç¼“å­˜(é¦–æ¬¡)' : 'Cached (first load)');
    }catch{ DATA=SEED.slice(0,20); SNAPSHOT_AT=SEEDED_AT;
      $('#kCache').textContent=(LANG==='zh' ? 'ç¦»çº¿ç§å­æ•°æ®' : 'Seeded offline data'); }
  }
  render();

  // æ’åºè¡¨å¤´äº¤äº’
  let SORT = {key:'rank', dir:'asc'};
  const sorter = (key)=>{
    SORT.dir = (SORT.key===key && SORT.dir==='asc')?'desc':'asc'; SORT.key=key;
    // é‡æ–°æ¸²æŸ“æ—¶è¯»å–å¤–éƒ¨ SORTï¼Œéœ€è¦é—­åŒ…å¤–å¼•ç”¨ï¼Œç®€åŒ–å¤„ç†ä¸ºç›´æ¥åˆ·æ–° DATA æ’åºé€»è¾‘
    const rows=$('#rows');
    const q=($('#search').value||'').trim().toLowerCase();
    const f=$('#filter').value;
    let list=DATA.slice();
    if(q) list=list.filter(x=> (x.name||'').toLowerCase().includes(q) || (x.symbol||'').toLowerCase().includes(q));
    if(f) list=list.filter(x=> classifyMechanism(x)===f);
    list=list.map((x,i)=>({...x,_rank:i+1}));
    const val=(x,k)=> k==='price' ? ((x.price?.USD ?? x.price ?? null) ?? -Infinity) :
                            k==='mcap' ? (x.mcapUSD ?? x.circulating?.peggedUSD ?? -Infinity) :
                            x._rank;
    list.sort((a,b)=> (SORT.dir==='asc'?1:-1) * (val(a,SORT.key)-val(b,SORT.key)));
    // ä¸´æ—¶å¡«å……å†æ›¿æ¢ï¼ˆå¯å¤ç”¨ render çš„æ¨¡æ¿ï¼‰
    rows.innerHTML='';
    list.forEach((x,idx)=>{
      const mech=classifyMechanism(x); const risk=riskFlags(x.symbol);
      const price=(x.price?.USD ?? x.price ?? null);
      const mcap=x.mcapUSD ?? (x.circulating?.peggedUSD ?? null);
      const dev=(price && Math.abs(price-1)>=0.003);
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td class="cell rank">${idx+1}</td>
        <td class="cell">
          <div class="token">
            <div class="tlogo">${(x.symbol||'?').slice(0,2)}</div>
            <div class="meta">
              <div class="name">${x.name||'â€”'}</div>
              <div class="sym">${x.symbol||''}</div>
            </div>
          </div>
        </td>
        <td class="cell">
          ${price==null?I18N[LANG].notAvail:`$${fmt(price,4)}`}
          ${price&&dev?`<span class="chip bad" style="margin-left:6px">âš  Depeg</span>`:''}
        </td>
        <td class="cell">${mcap==null?I18N[LANG].notAvail:`$${fmt(mcap,2)}`}</td>
        <td class="cell"><span class="chip">${{fiat:'ğŸ’µ Fiat',crypto:'ğŸ›¡ï¸ Crypto',algo:'ğŸ§® Algo',hybrid:'ğŸ§© Hybrid'}[classifyMechanism(x)]}</span></td>
        <td class="cell">
          <div class="chips">
            ${risk.blacklist?`<span class="chip bad">${LANG==='zh'?'é»‘åå•':'Blacklist'}</span>`:`<span class="chip ok">â€”</span>`}
            ${risk.freeze?`<span class="chip warn">${LANG==='zh'?'å†»ç»“':'Freeze'}</span>`:''}
          </div>
        </td>
      `;
      rows.appendChild(tr);
    });
  };
  document.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click',()=> sorter(th.dataset.sort));
  });
})();
</script>
</body>
</html>
